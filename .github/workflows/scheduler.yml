name: Daily Stock Report Scheduler

# KST 16:00 = UTC 07:00 (í‰ì¼ì—ë§Œ ì‹¤í–‰)
on:
  schedule:
    - cron: '0 7 * * 1-5'  # ì›”-ê¸ˆ UTC 07:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  run-daily-report:
    runs-on: ubuntu-latest
    
    env:
      TZ: Asia/Seoul
      BASE_URL: ${{ secrets.BASE_URL }}
      API_KEY: ${{ secrets.API_KEY }}
    
    steps:
      - name: Check environment variables
        run: |
          if [ -z "$BASE_URL" ]; then
            echo "âŒ BASE_URL secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi
          if [ -z "$API_KEY" ]; then
            echo "âŒ API_KEY secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì™„ë£Œ"
      
      - name: Display current time (KST)
        run: |
          echo "í˜„ì¬ ì‹œê° (KST): $(date)"
          echo "í˜„ì¬ ì‹œê° (UTC): $(date -u)"
      
      - name: Health check
        run: |
          echo "ğŸ“‹ ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘..."
          response=$(curl -s -w "%{http_code}" "$BASE_URL/v1/health" -o /tmp/health_response.json)
          
          if [ "$response" = "200" ]; then
            echo "âœ… ì„œë²„ ì •ìƒ ì‘ë™ ì¤‘"
            cat /tmp/health_response.json
          else
            echo "âŒ ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ (HTTP $response)"
            cat /tmp/health_response.json 2>/dev/null || echo "ì‘ë‹µ ì—†ìŒ"
            exit 1
          fi
      
      - name: Call daily pipeline
        run: |
          echo "ğŸš€ ë°ì¼ë¦¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘..."
          response=$(curl -s -w "%{http_code}" \
            -X POST "$BASE_URL/v1/run/daily" \
            -H "x-api-key: $API_KEY" \
            -H "Content-Type: application/json" \
            -o /tmp/daily_response.json)
          
          if [ "$response" = "200" ]; then
            echo "âœ… ë°ì¼ë¦¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì„±ê³µ"
            cat /tmp/daily_response.json
          else
            echo "âŒ ë°ì¼ë¦¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹¤íŒ¨ (HTTP $response)"
            cat /tmp/daily_response.json 2>/dev/null || echo "ì‘ë‹µ ì—†ìŒ"
            exit 1
          fi
      
      - name: Completion notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ ì¼ì¼ ë³´ê³ ì„œ ì‘ì—… ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
          else
            echo "âŒ ì¼ì¼ ë³´ê³ ì„œ ì‘ì—… ì‹¤íŒ¨"
          fi